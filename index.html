<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards de Oposiciones - Estudio con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .card {
            background-color: #2d3748;
            border: 1px solid #4a5568;
        }
        .btn-primary {
            background-color: #4299e1;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2b6cb0;
        }
        .btn-primary:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #4a5568;
        }
        .btn-secondary:hover {
            background-color: #2d3748;
        }
        .btn-ai {
            background-color: #5b21b6;
            color: white;
        }
        .btn-ai:hover {
            background-color: #4c1d95;
        }
        .input-dark {
            background-color: #1a202c;
            border-color: #4a5568;
        }
        .feedback-correct {
            background-color: #2f855a;
            border-left-color: #68d391;
        }
        .feedback-incorrect {
            background-color: #c53030;
            border-left-color: #fc8181;
        }
        .ai-response-card {
            background-color: rgba(76, 29, 149, 0.3);
            border-left: 4px solid #8b5cf6;
        }
        .spinner {
            border-top-color: #a78bfa;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-spinner {
            border: 4px solid #4a5568;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .csv-option {
            background-color: #2d3748;
            border: 2px solid #4a5568;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .csv-option:hover {
            border-color: #4299e1;
            background-color: #374151;
        }
        .csv-option.selected {
            border-color: #4299e1;
            background-color: #1e3a8a;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">

        <!-- 1. Pantalla de Selecci√≥n de Materia -->
        <div id="setup-screen" class="card p-8 rounded-xl shadow-lg transition-opacity duration-500">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-white">Flashcards de Oposiciones</h1>
                <p class="mt-2 text-slate-400">Selecciona tu materia de estudio</p>
            </div>
            
            <div class="mt-8 space-y-6">
                <!-- Pantalla de carga -->
                <div id="loading-section" class="text-center hidden">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-slate-300">Cargando preguntas...</p>
                </div>
                
                <!-- Selecci√≥n de materias -->
                <div id="csv-selection" class="space-y-4">
                    <h3 class="text-xl font-semibold text-white">Elige tu materia:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="csv-option p-4 rounded-lg" data-csv="./ADMINISTRATIVO.csv">
                            <h4 class="font-bold text-blue-300">üìã Derecho Administrativo</h4>
                            <p class="text-sm text-slate-400">Procedimiento, r√©gimen jur√≠dico, contratos p√∫blicos</p>
                        </div>
                        <div class="csv-option p-4 rounded-lg" data-csv="./CONSTITUCIONAL.csv">
                            <h4 class="font-bold text-red-300">‚öñÔ∏è Derecho Constitucional</h4>
                            <p class="text-sm text-slate-400">Constituci√≥n, derechos fundamentales</p>
                        </div>
                        <div class="csv-option p-4 rounded-lg" data-csv="./CIVIL.csv">
                            <h4 class="font-bold text-green-300">üèõÔ∏è Derecho Civil</h4>
                            <p class="text-sm text-slate-400">Personas, bienes, obligaciones</p>
                        </div>
                        <div class="csv-option p-4 rounded-lg" data-csv="./PENAL.csv">
                            <h4 class="font-bold text-purple-300">‚öîÔ∏è Derecho Penal</h4>
                            <p class="text-sm text-slate-400">Delitos, c√≥digo penal, procedimiento</p>
                        </div>
                        <div class="csv-option p-4 rounded-lg" data-csv="./LABORAL.csv">
                            <h4 class="font-bold text-yellow-300">üëî Derecho Laboral</h4>
                            <p class="text-sm text-slate-400">Contratos, despidos, seguridad social</p>
                        </div>
                        <div class="csv-option p-4 rounded-lg" data-csv="./TRIBUTARIO.csv">
                            <h4 class="font-bold text-orange-300">üí∞ Derecho Tributario</h4>
                            <p class="text-sm text-slate-400">Impuestos, hacienda p√∫blica</p>
                        </div>
                    </div>
                </div>
                
                <!-- Configuraci√≥n del juego -->
                <div id="config-section" class="hidden">
                    <div class="mb-4 p-4 bg-slate-900 rounded-lg">
                        <h4 class="text-lg font-semibold text-white mb-2">Archivo seleccionado:</h4>
                        <p id="selected-file-info" class="text-blue-400 font-medium"></p>
                    </div>
                    <div>
                        <label for="num-questions" class="block text-sm font-medium text-slate-300 mb-2">
                            N√∫mero de preguntas para el cuestionario
                        </label>
                        <input type="number" id="num-questions" 
                               class="input-dark w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                               min="1" placeholder="Ej: 10">
                    </div>
                </div>
                
                <!-- Mensajes informativos -->
                <div id="info-box" class="text-center text-sm text-slate-300 bg-slate-700 p-3 rounded-lg hidden"></div>
                <div id="error-box" class="text-center text-sm text-red-300 bg-red-800 bg-opacity-50 p-3 rounded-lg hidden"></div>
            </div>

            <div class="mt-8">
                <button id="start-button" class="w-full btn-primary font-bold py-3 px-4 rounded-lg transition-all" disabled>
                    Empezar Cuestionario
                </button>
            </div>
        </div>

        <!-- 2. Pantalla del Cuestionario -->
        <div id="quiz-screen" class="hidden card p-8 rounded-xl shadow-lg transition-opacity duration-500">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">
                    Pregunta <span id="current-q-num"></span> de <span id="total-q-num"></span>
                </h2>
                <div id="question-category" class="text-sm bg-blue-900 text-blue-300 font-semibold py-1 px-3 rounded-full"></div>
            </div>
            
            <div class="bg-slate-900 p-6 rounded-lg min-h-[120px] flex items-center justify-center">
                <p id="question-text" class="text-lg text-center font-semibold text-slate-200"></p>
            </div>

            <div class="mt-6">
                <div class="relative">
                    <textarea id="user-answer" rows="3" 
                              class="input-dark w-full p-4 pr-12 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                              placeholder="Escribe tu respuesta..."></textarea>
                    <button id="mic-button" class="absolute top-1/2 right-4 -translate-y-1/2 text-slate-400 hover:text-blue-400" 
                            title="Contestar por voz">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-1a6 6 0 11-12 0H3a7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <p id="mic-status" class="text-sm text-center mt-2 text-slate-500 h-5"></p>
            </div>

            <div class="mt-4">
                <button id="verify-button" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg transition-all">
                    Ver Respuesta Correcta
                </button>
            </div>

            <!-- Secci√≥n de Feedback -->
            <div id="feedback-section" class="hidden mt-6 space-y-4">
                <div id="feedback-message" class="p-4 text-white font-bold rounded-lg border-l-4 text-center"></div>
                
                <div class="p-4 bg-slate-900 rounded-lg">
                    <h4 class="font-bold text-slate-300">Respuesta Correcta:</h4>
                    <p id="correct-answer-text" class="mt-1 text-slate-300"></p>
                    <h4 class="font-bold text-slate-300 mt-3">Justificaci√≥n:</h4>
                    <p id="reasoning-text" class="mt-1 text-slate-400"></p>
                    
                    <div class="mt-4">
                        <a id="legal-ref-link" href="#" target="_blank" rel="noopener noreferrer" 
                           class="text-blue-400 hover:text-blue-300 hover:underline">
                            <span class="font-bold">üìã Referencia legal:</span>
                            <span id="legal-ref-text"></span>
                        </a>
                    </div>
                </div>
                
                <!-- Explicaci√≥n con IA -->
                <button id="ai-enhance-button" class="w-full btn-ai font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                    Explicaci√≥n Detallada ü§ñ
                </button>
                <div id="ai-response-container" class="hidden p-4 rounded-lg ai-response-card">
                    <div id="ai-spinner" class="flex items-center justify-center gap-2 text-violet-300">
                        <div class="spinner h-5 w-5 rounded-full border-2 border-transparent"></div>
                        Generando explicaci√≥n...
                    </div>
                    <div id="ai-response-content"></div>
                </div>

                <!-- Botones de evaluaci√≥n -->
                <div id="evaluation-buttons" class="grid grid-cols-2 gap-4">
                    <button id="correct-btn" class="flex items-center justify-center gap-2 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-all">
                        ‚úÖ ¬°La acert√©!
                    </button>
                    <button id="incorrect-btn" class="flex items-center justify-center gap-2 w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-all">
                        ‚ùå No la sab√≠a
                    </button>
                </div>
            </div>
        </div>

        <!-- 3. Pantalla de Resultados -->
        <div id="results-screen" class="hidden card p-8 rounded-xl shadow-lg transition-opacity duration-500">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-white">¬°Sesi√≥n Finalizada!</h2>
                <p id="final-message" class="mt-4 text-lg text-slate-300"></p>
            </div>
            
            <div class="mt-8 p-4 bg-slate-900 rounded-lg text-center">
                <h3 class="text-xl font-bold text-white mb-2">Tus Resultados</h3>
                <div class="flex justify-center gap-8 text-2xl">
                    <div><span class="font-bold text-green-400" id="correct-count"></span> Correctas</div>
                    <div><span class="font-bold text-red-400" id="incorrect-count"></span> Incorrectas</div>
                </div>
            </div>
            
            <div id="review-section" class="mt-6 hidden">
                <h3 class="text-xl font-bold text-white mb-4">Conceptos a Repasar</h3>
                <div id="review-list" class="space-y-4 max-h-60 overflow-y-auto pr-2"></div>
            </div>
            
            <div class="mt-8">
                <button id="restart-button" class="w-full btn-primary font-bold py-3 px-6 rounded-lg transition-all">
                    Empezar de Nuevo
                </button>
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SELECTORES DEL DOM ---
        const setupScreen = document.getElementById('setup-screen'),
              quizScreen = document.getElementById('quiz-screen'),
              resultsScreen = document.getElementById('results-screen'),
              loadingSection = document.getElementById('loading-section'),
              csvSelection = document.getElementById('csv-selection'),
              configSection = document.getElementById('config-section'),
              selectedFileInfo = document.getElementById('selected-file-info'),
              numQuestionsInput = document.getElementById('num-questions'),
              startButton = document.getElementById('start-button'),
              errorBox = document.getElementById('error-box'),
              infoBox = document.getElementById('info-box'),
              category = document.getElementById('question-category'),
              questionText = document.getElementById('question-text'),
              userAnswer = document.getElementById('user-answer'),
              micButton = document.getElementById('mic-button'),
              micStatus = document.getElementById('mic-status'),
              verifyButton = document.getElementById('verify-button'),
              feedbackSection = document.getElementById('feedback-section'),
              feedbackMessage = document.getElementById('feedback-message'),
              correctAnswerText = document.getElementById('correct-answer-text'),
              reasoningText = document.getElementById('reasoning-text'),
              legalRefLink = document.getElementById('legal-ref-link'),
              legalRefText = document.getElementById('legal-ref-text'),
              aiEnhanceButton = document.getElementById('ai-enhance-button'),
              aiResponseContainer = document.getElementById('ai-response-container'),
              aiSpinner = document.getElementById('ai-spinner'),
              aiResponseContent = document.getElementById('ai-response-content'),
              evalButtons = document.getElementById('evaluation-buttons'),
              correctBtn = document.getElementById('correct-btn'),
              incorrectBtn = document.getElementById('incorrect-btn'),
              currentQNum = document.getElementById('current-q-num'),
              totalQNum = document.getElementById('total-q-num'),
              finalMessage = document.getElementById('final-message'),
              correctCount = document.getElementById('correct-count'),
              incorrectCount = document.getElementById('incorrect-count'),
              reviewSection = document.getElementById('review-section'),
              reviewList = document.getElementById('review-list'),
              restartButton = document.getElementById('restart-button');

        // --- ESTADO DE LA APP ---
        let allQuestions = [], 
            quizQuestions = [], 
            correctAnswers = [], 
            incorrectAnswers = [], 
            currentQuestionIndex = 0,
            selectedCSV = null;

        // Mapeo de archivos disponibles
        const CSV_FILES = {
            './ADMINISTRATIVO.csv': 'Derecho Administrativo',
            './CONSTITUCIONAL.csv': 'Derecho Constitucional',
            './CIVIL.csv': 'Derecho Civil',
            './PENAL.csv': 'Derecho Penal',
            './LABORAL.csv': 'Derecho Laboral',
            './TRIBUTARIO.csv': 'Derecho Tributario'
        };

        // --- FUNCIONES PRINCIPALES ---

        // Algoritmo Fisher-Yates para mezcla completamente aleatoria
        const shuffleArray = (array) => {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        };

        // Funci√≥n para parsear CSV
        const parseCSV = (text) => {
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error('CSV vac√≠o o sin cabeceras.');
            
            const questions = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                try {
                    const csvRegex = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/;
                    const fields = line.split(csvRegex);
                    
                    if (fields.length < 6) continue;
                    
                    const cleanField = (field) => {
                        if (!field) return '';
                        return field.replace(/^"/, '').replace(/"$/, '').replace(/""/g, '"').trim();
                    };
                    
                    const question = {
                        ID: cleanField(fields[0]),
                        Category: cleanField(fields[1]),
                        Question: cleanField(fields[2]),
                        Answer: cleanField(fields[3]),
                        Reasoning: cleanField(fields[4]),
                        Legal_Reference: cleanField(fields[5])
                    };
                    
                    if (question.ID && question.Category && question.Question && question.Answer) {
                        questions.push(question);
                    }
                } catch (parseError) {
                    console.warn(`Error parsing line ${i}: ${parseError.message}`);
                    continue;
                }
            }
            
            return questions;
        };

        // Cargar archivo CSV seleccionado
        const loadSelectedCSV = async () => {
            if (!selectedCSV) return;

            try {
                showLoading();
                errorBox.classList.add('hidden');
                
                const response = await fetch(selectedCSV);
                if (!response.ok) {
                    throw new Error(`Error al cargar el archivo: ${response.status}`);
                }
                
                const text = await response.text();
                allQuestions = parseCSV(text);
                
                if (allQuestions.length === 0) {
                    throw new Error("No se pudieron procesar las preguntas.");
                }

                // ¬°MEZCLADO COMPLETAMENTE ALEATORIO!
                allQuestions = shuffleArray(allQuestions);
                
                hideLoading();
                showConfig();
                
                const fileName = CSV_FILES[selectedCSV];
                selectedFileInfo.textContent = `${fileName} - ${allQuestions.length} preguntas`;
                infoBox.textContent = `¬°√âxito! Preguntas mezcladas completamente al azar.`;
                infoBox.classList.remove('hidden');
                
                numQuestionsInput.max = allQuestions.length;
                numQuestionsInput.value = Math.min(10, allQuestions.length);
                startButton.disabled = false;

            } catch (error) {
                console.error('Error loading CSV:', error);
                hideLoading();
                showCSVSelection();
                errorBox.textContent = `Error: ${error.message}`;
                errorBox.classList.remove('hidden');
            }
        };

        // Funciones de interfaz
        const showLoading = () => {
            csvSelection.classList.add('hidden');
            configSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');
        };

        const hideLoading = () => {
            loadingSection.classList.add('hidden');
        };

        const showConfig = () => {
            configSection.classList.remove('hidden');
        };

        const showCSVSelection = () => {
            csvSelection.classList.remove('hidden');
        };

        // Formatear referencia legal
        const formatLegalReferenceText = (questionData) => {
            const lawMapping = {
                'BOE-A-2015-10565': 'Ley 39/2015',
                'BOE-A-2015-10566': 'Ley 40/2015',
                'BOE-A-1978-31229': 'CE',
                'BOE-A-2017-12902': 'LCSP',
                'BOE-A-2003-23186': 'LPAP',
                'BOE-A-2013-12887': 'Ley 19/2013',
                'BOE-A-1889-4763': 'C√≥digo Civil',
                'BOE-A-2007-6115': 'Ley de Igualdad',
                'BOE-A-1954-6364': 'LEF',
                'BOE-A-2007-7788': 'EBEP'
            };

            const url = questionData.Legal_Reference;
            if (!url) return "Sin referencia";
            
            let lawText = '';
            let articleText = '';

            const boeMatch = url.match(/id=(BOE-A-\d{4}-\d+)/);
            if (boeMatch && lawMapping[boeMatch[1]]) {
                lawText = lawMapping[boeMatch[1]];
            }

            const articleMatch = url.match(/#a(\d+)/);
            if (articleMatch) {
                articleText = `, art. ${articleMatch[1]}`;
            }

            return lawText ? `${lawText}${articleText}` : "Ver disposici√≥n";
        };

        // Iniciar juego
        const startGame = () => {
            const num = parseInt(numQuestionsInput.value);
            if (isNaN(num) || num <= 0 || num > allQuestions.length) {
                errorBox.textContent = `Introduce un n√∫mero v√°lido entre 1 y ${allQuestions.length}.`;
                errorBox.classList.remove('hidden');
                return;
            }
            
            // Resetear estado
            correctAnswers = [];
            incorrectAnswers = [];
            currentQuestionIndex = 0;
            
            // ¬°SELECCI√ìN COMPLETAMENTE ALEATORIA!
            const shuffledQuestions = shuffleArray(allQuestions);
            quizQuestions = shuffledQuestions.slice(0, num);
            
            // Cambiar a pantalla de juego
            setupScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            displayQuestion();
        };

        // Mostrar pregunta actual
        const displayQuestion = () => {
            if (currentQuestionIndex >= quizQuestions.length) {
                showResults();
                return;
            }
            
            const q = quizQuestions[currentQuestionIndex];
            
            // Mostrar pregunta
            category.textContent = q.Category;
            questionText.textContent = q.Question;
            
            // Formatear respuesta
            let formattedAnswer = q.Answer
                .replace(/Palabras clave:/g, '<br><br><strong>Palabras clave:</strong>')
                .replace(/Analog√≠a:/g, '<br><br><strong>Analog√≠a:</strong>');
            correctAnswerText.innerHTML = formattedAnswer;
            
            reasoningText.textContent = q.Reasoning;
            
            // Referencia legal
            if (q.Legal_Reference) {
                legalRefLink.href = q.Legal_Reference;
                legalRefText.textContent = formatLegalReferenceText(q);
                legalRefLink.style.display = 'inline-block';
            } else {
                legalRefLink.style.display = 'none';
            }

            // Actualizar contadores
            currentQNum.textContent = currentQuestionIndex + 1;
            totalQNum.textContent = quizQuestions.length;
            
            // Resetear interfaz
            userAnswer.value = '';
            feedbackSection.classList.add('hidden');
            aiResponseContainer.classList.add('hidden');
            aiResponseContent.innerHTML = '';
            aiEnhanceButton.classList.remove('hidden');
            verifyButton.classList.remove('hidden');
            evalButtons.classList.remove('hidden');
        };
        
        // Mostrar feedback
        const showFeedback = () => {
            verifyButton.classList.add('hidden');
            feedbackSection.classList.remove('hidden');
            feedbackMessage.classList.add('hidden');
        };

        // Manejar evaluaci√≥n - ¬°PASO AUTOM√ÅTICO!
        const handleEvaluation = (isCorrect) => {
            evalButtons.classList.add('hidden');
            
            if (isCorrect) {
                correctAnswers.push(quizQuestions[currentQuestionIndex]);
                feedbackMessage.textContent = '¬°Excelente! Respuesta correcta. üéâ';
                feedbackMessage.className = 'p-4 text-white font-bold rounded-lg border-l-4 text-center feedback-correct';
            } else {
                incorrectAnswers.push(quizQuestions[currentQuestionIndex]);
                feedbackMessage.textContent = '¬°√Ånimo! Lo importante es aprender. üí™';
                feedbackMessage.className = 'p-4 text-white font-bold rounded-lg border-l-4 text-center feedback-incorrect';
            }
            feedbackMessage.classList.remove('hidden');
            
            // ¬°PASO AUTOM√ÅTICO DESPU√âS DE 2 SEGUNDOS!
            setTimeout(() => {
                currentQuestionIndex++;
                displayQuestion();
            }, 2000);
        };
        
        // Explicaci√≥n con IA (simulada)
        const getAIEnhancement = async () => {
            const q = quizQuestions[currentQuestionIndex];
            
            aiEnhanceButton.classList.add('hidden');
            aiResponseContainer.classList.remove('hidden');
            aiSpinner.classList.remove('hidden');
            aiResponseContent.innerHTML = '';

            try {
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const mockResponse = `
                    <h5 class="font-bold text-violet-300 mb-3">üß† Explicaci√≥n Detallada:</h5>
                    <div class="space-y-3 text-slate-300">
                        <p><strong>üìö Concepto clave:</strong> Esta pregunta trata sobre <strong>${q.Category}</strong>. El principio fundamental es que ${q.Answer.split('.')[0].toLowerCase()}.</p>
                        <p><strong>üèõÔ∏è Ejemplo pr√°ctico:</strong> Imagina que un ciudadano presenta una solicitud en el ayuntamiento. Este principio garantiza que la administraci√≥n debe actuar de manera transparente y justa.</p>
                        <p><strong>üí° Truco para recordar:</strong> Piensa en esta norma como una "garant√≠a de protecci√≥n" que siempre favorece la seguridad jur√≠dica del ciudadano.</p>
                        <p><strong>‚öñÔ∏è Importancia:</strong> Este concepto es fundamental en las oposiciones porque aparece en m√∫ltiples contextos del derecho administrativo espa√±ol.</p>
                    </div>
                `;
                
                aiResponseContent.innerHTML = mockResponse;
                
            } catch (error) {
                aiResponseContent.innerHTML = `<p class="text-red-400">Error al generar explicaci√≥n: ${error.message}</p>`;
            } finally {
                aiSpinner.classList.add('hidden');
            }
        };

        // Mostrar resultados
        const showResults = () => {
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            correctCount.textContent = correctAnswers.length;
            incorrectCount.textContent = incorrectAnswers.length;
            
            const percentage = quizQuestions.length > 0 ? (correctAnswers.length / quizQuestions.length) * 100 : 0;
            
            if (percentage >= 80) {
                finalMessage.textContent = "¬°Magn√≠fico trabajo! Tu esfuerzo est√° dando frutos. üåü";
            } else if (percentage >= 50) {
                finalMessage.textContent = "¬°Buen progreso! Est√°s construyendo una base s√≥lida. üí™";
            } else {
                finalMessage.textContent = "Cada error es un paso hacia el √©xito. ¬°Sigue adelante! üöÄ";
            }
            
            // Secci√≥n de repaso
            if (incorrectAnswers.length > 0) {
                reviewList.innerHTML = incorrectAnswers.map((q, i) => 
                    `<div class="p-3 bg-slate-900 rounded-lg">
                        <p class="font-semibold text-slate-300">${i + 1}. ${q.Question}</p>
                        <p class="mt-1 text-green-400"><strong>R:</strong> ${q.Answer}</p>
                    </div>`
                ).join('');
                reviewSection.classList.remove('hidden');
            } else {
                reviewSection.classList.add('hidden');
            }
        };
        
        // Reiniciar aplicaci√≥n
        const restartApp = () => {
            resultsScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            
            // Resetear selecci√≥n
            csvSelection.classList.remove('hidden');
            configSection.classList.add('hidden');
            loadingSection.classList.add('hidden');
            
            document.querySelectorAll('.csv-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            selectedCSV = null;
            numQuestionsInput.value = '';
            startButton.disabled = true;
            
            errorBox.classList.add('hidden');
            infoBox.classList.add('hidden');
            
            // Resetear datos
            allQuestions = [];
            quizQuestions = [];
            correctAnswers = [];
            incorrectAnswers = [];
            currentQuestionIndex = 0;
        };

        // --- EVENT LISTENERS ---
        
        // Selecci√≥n de archivo CSV
        document.querySelectorAll('.csv-option').forEach(option => {
            option.addEventListener('click', () => {
                // Quitar selecci√≥n anterior
                document.querySelectorAll('.csv-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Seleccionar nuevo
                option.classList.add('selected');
                selectedCSV = option.dataset.csv;
                
                // Cargar archivo
                loadSelectedCSV();
            });
        });

        startButton.addEventListener('click', startGame);
        verifyButton.addEventListener('click', showFeedback);
        aiEnhanceButton.addEventListener('click', getAIEnhancement);
        correctBtn.addEventListener('click', () => handleEvaluation(true));
        incorrectBtn.addEventListener('click', () => handleEvaluation(false));
        restartButton.addEventListener('click', restartApp);

        // Reconocimiento de voz
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.interimResults = false;
            
            micButton.addEventListener('click', () => {
                try {
                    micStatus.textContent = 'üé§ Escuchando...';
                    recognition.start();
                } catch(e) {
                    micStatus.textContent = 'El micr√≥fono ya est√° activo.';
                }
            });
            
            recognition.onresult = (event) => {
                userAnswer.value = event.results[0][0].transcript;
                micStatus.textContent = 'Respuesta capturada ‚úì';
                setTimeout(() => { micStatus.textContent = ''; }, 2000);
            };
            
            recognition.onerror = (event) => {
                micStatus.textContent = `Error: ${event.error}`;
                setTimeout(() => { micStatus.textContent = ''; }, 3000);
            };
            
            recognition.onend = () => {
                if (micStatus.textContent === 'üé§ Escuchando...') {
                    micStatus.textContent = '';
                }
            };
        } else {
            micButton.style.display = 'none';
        }

        // --- INICIAR APLICACI√ìN ---
        console.log('Flashcards de Oposiciones cargado correctamente');
    });
    </script>
</body>
</html>
