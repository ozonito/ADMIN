<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards de Oposiciones - Estudio con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .card {
            background-color: #2d3748;
            border: 1px solid #4a5568;
        }
        .btn-primary {
            background-color: #4299e1;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2b6cb0;
        }
        .btn-primary:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #4a5568;
        }
        .btn-secondary:hover {
            background-color: #2d3748;
        }
        .btn-ai {
            background-color: #5b21b6;
            color: white;
        }
        .btn-ai:hover {
            background-color: #4c1d95;
        }
        .input-dark {
            background-color: #1a202c;
            border-color: #4a5568;
        }
        .feedback-correct {
            background-color: #2f855a;
            border-left-color: #68d391;
        }
        .feedback-incorrect {
            background-color: #c53030;
            border-left-color: #fc8181;
        }
        .ai-response-card {
            background-color: rgba(76, 29, 149, 0.3);
            border-left: 4px solid #8b5cf6;
        }
        .spinner {
            border-top-color: #a78bfa;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-spinner {
            border: 4px solid #4a5568;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .csv-option {
            background-color: #2d3748;
            border: 2px solid #4a5568;
            transition: all 0.3s ease;
        }
        .csv-option:hover {
            border-color: #4299e1;
            background-color: #374151;
        }
        .csv-option.selected {
            border-color: #4299e1;
            background-color: #1e3a8a;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">

        <!-- 1. Pantalla de Configuraci√≥n -->
        <div id="setup-screen" class="card p-8 rounded-xl shadow-lg transition-opacity duration-500">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-white">Flashcards de Oposiciones con IA</h1>
                <p class="mt-2 text-slate-400">Selecciona tu materia y configura tu cuestionario</p>
            </div>
            
            <div class="mt-8 space-y-6">
                <div id="loading-section" class="text-center hidden">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-slate-300">Cargando preguntas...</p>
                </div>
                
                <div id="csv-selection" class="space-y-4">
                    <h3 class="text-xl font-semibold text-white">Selecciona tu materia:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="csv-option p-4 rounded-lg cursor-pointer" data-csv="./ADMINISTRATIVO.csv">
                            <h4 class="font-bold text-blue-300">üìã Derecho Administrativo</h4>
                            <p class="text-sm text-slate-400">Procedimiento, r√©gimen jur√≠dico, contratos p√∫blicos</p>
                        </div>
                        <div class="csv-option p-4 rounded-lg cursor-pointer" data-csv="./CONSTITUCIONAL.csv">
                            <h4 class="font-bold text-red-300">‚öñÔ∏è Derecho Constitucional</h4>
                            <p class="text-sm text-slate-400">Constituci√≥n, derechos fundamentales, tribunal constitucional</p>
                        </div>
                        <div class="csv-option p-4 rounded-lg cursor-pointer" data-csv="./CIVIL.csv">
                            <h4 class="font-bold text-green-300">üèõÔ∏è Derecho Civil</h4>
                            <p class="text-sm text-slate-400">Personas, bienes, obligaciones, contratos</p>
                        </div>
                        <div class="csv-option p-4 rounded-lg cursor-pointer" data-csv="./PENAL.csv">
                            <h4 class="font-bold text-purple-300">‚öîÔ∏è Derecho Penal</h4>
                            <p class="text-sm text-slate-400">Delitos, faltas, c√≥digo penal, procedimiento</p>
                        </div>
                        <div class="csv-option p-4 rounded-lg cursor-pointer" data-csv="./LABORAL.csv">
                            <h4 class="font-bold text-yellow-300">üëî Derecho Laboral</h4>
                            <p class="text-sm text-slate-400">Contratos, despidos, seguridad social</p>
                        </div>
                        <div class="csv-option p-4 rounded-lg cursor-pointer" data-csv="./TRIBUTARIO.csv">
                            <h4 class="font-bold text-orange-300">üí∞ Derecho Tributario</h4>
                            <p class="text-sm text-slate-400">Impuestos, hacienda p√∫blica, procedimiento tributario</p>
                        </div>
                    </div>
                </div>
                
                <div id="config-section" class="hidden">
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-white mb-2">Archivo seleccionado:</h4>
                        <p id="selected-file-info" class="text-blue-400 font-medium"></p>
                    </div>
                    <div>
                        <label for="num-questions" class="block text-sm font-medium text-slate-300">N√∫mero de preguntas para el cuestionario</label>
                        <input type="number" id="num-questions" class="input-dark mt-1 block w-full px-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" min="1" placeholder="Ej: 10" disabled>
                    </div>
                    <div class="mt-4">
                        <label for="gemini-api-key" class="block text-sm font-medium text-slate-300">API Key de Google Gemini (opcional - para explicaciones con IA)</label>
                        <input type="password" id="gemini-api-key" class="input-dark mt-1 block w-full px-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Obt√©n tu API gratuita en ai.google.dev">
                        <p class="text-xs text-slate-500 mt-1">Si no tienes API key, las explicaciones ser√°n simuladas</p>
                    </div>
                </div>
                
                <div id="info-box" class="text-center text-sm text-slate-300 bg-slate-700 p-3 rounded-lg hidden"></div>
                <div id="error-box" class="text-center text-sm text-red-300 bg-red-800 bg-opacity-50 p-3 rounded-lg hidden"></div>
            </div>

            <div class="mt-8">
                <button id="start-button" class="w-full btn-primary font-bold py-3 px-4 rounded-lg transition-all" disabled>
                    Empezar Cuestionario
                </button>
            </div>
        </div>

        <!-- 2. Pantalla del Cuestionario -->
        <div id="quiz-screen" class="hidden card p-8 rounded-xl shadow-lg transition-opacity duration-500">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Pregunta <span id="current-q-num"></span> de <span id="total-q-num"></span></h2>
                <div id="question-category" class="text-sm bg-blue-900 text-blue-300 font-semibold py-1 px-3 rounded-full"></div>
            </div>
            
            <div class="bg-slate-900 p-6 rounded-lg min-h-[120px] flex items-center justify-center">
                <p id="question-text" class="text-lg text-center font-semibold text-slate-200"></p>
            </div>

            <div class="mt-6">
                <div class="relative">
                    <textarea id="user-answer" rows="3" class="input-dark w-full p-4 pr-12 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Escribe o dicta tu respuesta..."></textarea>
                    <button id="mic-button" class="absolute top-1/2 right-4 -translate-y-1/2 text-slate-400 hover:text-blue-400" title="Contestar por voz">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-1a6 6 0 11-12 0H3a7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <p id="mic-status" class="text-sm text-center mt-2 text-slate-500 h-5"></p>
            </div>

            <div class="mt-4">
                <button id="verify-button" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg transition-all">Verificar Respuesta</button>
            </div>

            <!-- Secci√≥n de Feedback -->
            <div id="feedback-section" class="hidden mt-6 space-y-4">
                <div id="feedback-message" class="p-4 text-white font-bold rounded-lg border-l-4 text-center"></div>
                <div class="p-4 bg-slate-900 rounded-lg">
                    <h4 class="font-bold text-slate-300">Respuesta Correcta:</h4>
                    <p id="correct-answer-text" class="mt-1 text-slate-300"></p>
                    <h4 class="font-bold text-slate-300 mt-3">Justificaci√≥n:</h4>
                    <p id="reasoning-text" class="mt-1 text-slate-400"></p>
                    
                    <div class="mt-4">
                        <a id="legal-ref-link" href="#" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300 hover:underline">
                            <span class="font-bold">üìã Referencia legal:</span>
                            <span id="legal-ref-text"></span>
                        </a>
                    </div>
                </div>
                
                <!-- Bot√≥n y contenedor de IA -->
                <button id="ai-enhance-button" class="w-full btn-ai font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2">Explicar con IA ü§ñ</button>
                <div id="ai-response-container" class="hidden p-4 rounded-lg ai-response-card">
                    <div id="ai-spinner" class="flex items-center justify-center gap-2 text-violet-300">
                        <div class="spinner h-5 w-5 rounded-full border-2 border-transparent"></div>
                        Analizando...
                    </div>
                    <div id="ai-response-content"></div>
                </div>

                <div id="evaluation-buttons" class="grid grid-cols-2 gap-4">
                    <button id="correct-btn" class="flex items-center justify-center gap-2 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-all">‚úÖ ¬°La acert√©!</button>
                    <button id="incorrect-btn" class="flex items-center justify-center gap-2 w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-all">‚ùå A repasar</button>
                </div>
            </div>
        </div>

        <!-- 3. Pantalla de Resultados -->
        <div id="results-screen" class="hidden card p-8 rounded-xl shadow-lg transition-opacity duration-500">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-white">¬°Sesi√≥n Finalizada!</h2>
                <p id="final-message" class="mt-4 text-lg text-slate-300"></p>
            </div>
            <div class="mt-8 p-4 bg-slate-900 rounded-lg text-center">
                <h3 class="text-xl font-bold text-white mb-2">Tus Resultados</h3>
                <div class="flex justify-center gap-8 text-2xl">
                    <div><span class="font-bold text-green-400" id="correct-count"></span> Correctas</div>
                    <div><span class="font-bold text-red-400" id="incorrect-count"></span> Incorrectas</div>
                </div>
            </div>
            <div id="review-section" class="mt-6 hidden">
                <h3 class="text-xl font-bold text-white mb-4">Conceptos a Repasar</h3>
                <div id="review-list" class="space-y-4 max-h-60 overflow-y-auto pr-2"></div>
            </div>
            <div class="mt-6">
                <h3 class="text-xl font-bold text-white mb-4">Estad√≠sticas de Preguntas</h3>
                <div class="max-h-60 overflow-y-auto pr-2">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-700 text-slate-300">
                            <tr><th class="p-2">Pregunta</th><th class="p-2 w-28 text-center">Formulada</th></tr>
                        </thead>
                        <tbody id="occurrence-table-body" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>
            <div class="mt-8">
                <button id="restart-button" class="w-full btn-primary font-bold py-3 px-6 rounded-lg transition-all">Empezar de Nuevo</button>
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SELECTORES DEL DOM ---
        const setupScreen = document.getElementById('setup-screen'),
              quizScreen = document.getElementById('quiz-screen'),
              resultsScreen = document.getElementById('results-screen'),
              loadingSection = document.getElementById('loading-section'),
              csvSelection = document.getElementById('csv-selection'),
              configSection = document.getElementById('config-section'),
              selectedFileInfo = document.getElementById('selected-file-info'),
              numQuestionsInput = document.getElementById('num-questions'),
              geminiApiKeyInput = document.getElementById('gemini-api-key'),
              startButton = document.getElementById('start-button'),
              errorBox = document.getElementById('error-box'),
              infoBox = document.getElementById('info-box'),
              category = document.getElementById('question-category'),
              questionText = document.getElementById('question-text'),
              userAnswer = document.getElementById('user-answer'),
              micButton = document.getElementById('mic-button'),
              micStatus = document.getElementById('mic-status'),
              verifyButton = document.getElementById('verify-button'),
              feedbackSection = document.getElementById('feedback-section'),
              feedbackMessage = document.getElementById('feedback-message'),
              correctAnswerText = document.getElementById('correct-answer-text'),
              reasoningText = document.getElementById('reasoning-text'),
              legalRefLink = document.getElementById('legal-ref-link'),
              legalRefText = document.getElementById('legal-ref-text'),
              aiEnhanceButton = document.getElementById('ai-enhance-button'),
              aiResponseContainer = document.getElementById('ai-response-container'),
              aiSpinner = document.getElementById('ai-spinner'),
              aiResponseContent = document.getElementById('ai-response-content'),
              evalButtons = document.getElementById('evaluation-buttons'),
              correctBtn = document.getElementById('correct-btn'),
              incorrectBtn = document.getElementById('incorrect-btn'),
              currentQNum = document.getElementById('current-q-num'),
              totalQNum = document.getElementById('total-q-num'),
              finalMessage = document.getElementById('final-message'),
              correctCount = document.getElementById('correct-count'),
              incorrectCount = document.getElementById('incorrect-count'),
              reviewSection = document.getElementById('review-section'),
              reviewList = document.getElementById('review-list'),
              occurrenceTableBody = document.getElementById('occurrence-table-body'),
              restartButton = document.getElementById('restart-button');

        // --- ESTADO DE LA APP ---
        let allQuestions = [], quizQuestions = [], correctAnswers = [], incorrectAnswers = [], currentQuestionIndex = 0;
        let selectedCSV = null;
        const OCCURRENCE_KEY = 'flashcardOccurrences';

        // Archivos CSV disponibles
        const CSV_FILES = {
            './ADMINISTRATIVO.csv': 'Derecho Administrativo',
            './CONSTITUCIONAL.csv': 'Derecho Constitucional', 
            './CIVIL.csv': 'Derecho Civil',
            './PENAL.csv': 'Derecho Penal',
            './LABORAL.csv': 'Derecho Laboral',
            './TRIBUTARIO.csv': 'Derecho Tributario'
        };

        // --- L√ìGICA DE LA APP ---

        const occurrenceTracker = {
            get: () => JSON.parse(localStorage.getItem(OCCURRENCE_KEY)) || {},
            save: (data) => localStorage.setItem(OCCURRENCE_KEY, JSON.stringify(data)),
            init: (questions) => {
                const data = occurrenceTracker.get();
                let updated = false;
                questions.forEach(q => {
                    if (q && q.ID && data[q.ID] === undefined) {
                        data[q.ID] = 0;
                        updated = true;
                    }
                });
                if (updated) occurrenceTracker.save(data);
            },
            increment: (questionId) => {
                if (!questionId) return;
                const data = occurrenceTracker.get();
                if (data[questionId] !== undefined) {
                    data[questionId]++;
                    occurrenceTracker.save(data);
                }
            }
        };

        // Funci√≥n para parsear CSV mejorada
        const parseCSV = (text) => {
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error('CSV vac√≠o o sin cabeceras.');
            
            const questions = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                try {
                    // Usar expresi√≥n regular para parsear CSV con comillas
                    const csvRegex = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/;
                    const fields = line.split(csvRegex);
                    
                    if (fields.length < 6) continue;
                    
                    // Limpiar campos de comillas
                    const cleanField = (field) => {
                        if (!field) return '';
                        return field.replace(/^"/, '').replace(/"$/, '').replace(/""/g, '"').trim();
                    };
                    
                    const question = {
                        ID: cleanField(fields[0]),
                        Category: cleanField(fields[1]),
                        Question: cleanField(fields[2]),
                        Answer: cleanField(fields[3]),
                        Reasoning: cleanField(fields[4]),
                        Legal_Reference: cleanField(fields[5])
                    };
                    
                    // Validar que los campos esenciales no est√©n vac√≠os
                    if (question.ID && question.Category && question.Question && question.Answer) {
                        questions.push(question);
                    }
                } catch (parseError) {
                    console.warn(`Error parsing line ${i}: ${parseError.message}`);
                    continue;
                }
            }
            
            return questions;
        };

        // Algoritmo Fisher-Yates para shuffle completamente aleatorio
        const shuffleArray = (array) => {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        };

        // Funci√≥n para cargar CSV seleccionado
        const loadSelectedCSV = async () => {
            if (!selectedCSV) return;

            try {
                loadingSection.classList.remove('hidden');
                csvSelection.classList.add('hidden');
                configSection.classList.add('hidden');
                errorBox.classList.add('hidden');
                
                const response = await fetch(selectedCSV);
                if (!response.ok) {
                    throw new Error(`Error al cargar el archivo: ${response.status} ${response.statusText}`);
                }
                
                const text = await response.text();
                allQuestions = parseCSV(text);
                
                if (allQuestions.length === 0) {
                    throw new Error("No se pudieron procesar las preguntas. Revisa el formato del CSV.");
                }

                // Shuffle completamente aleatorio usando Fisher-Yates
                allQuestions = shuffleArray(allQuestions);

                occurrenceTracker.init(allQuestions);
                
                // Ocultar loading y mostrar configuraci√≥n
                loadingSection.classList.add('hidden');
                configSection.classList.remove('hidden');
                
                // Mostrar informaci√≥n de √©xito
                const fileName = CSV_FILES[selectedCSV];
                selectedFileInfo.textContent = `${fileName} - ${allQuestions.length} preguntas cargadas`;
                infoBox.textContent = `¬°√âxito! Preguntas mezcladas aleatoriamente.`;
                infoBox.classList.remove('hidden');
                
                // Configurar input de n√∫mero de preguntas
                numQuestionsInput.max = allQuestions.length;
                numQuestionsInput.value = Math.min(10, allQuestions.length);
                numQuestionsInput.disabled = false;
                startButton.disabled = false;

            } catch (error) {
                console.error('Error loading CSV:', error);
                loadingSection.classList.add('hidden');
                csvSelection.classList.remove('hidden');
                errorBox.textContent = `Error al cargar las preguntas: ${error.message}`;
                errorBox.classList.remove('hidden');
            }
        };

        const formatLegalReferenceText = (questionData) => {
            const lawMapping = {
                'BOE-A-2015-10565': 'Ley 39/2015',
                'BOE-A-2015-10566': 'Ley 40/2015',
                'BOE-A-1978-31229': 'CE',
                'BOE-A-2017-12902': 'LCSP',
                'BOE-A-2003-23186': 'LPAP',
                'BOE-A-2013-12887': 'Ley 19/2013',
                'BOE-A-1889-4763': 'C√≥digo Civil',
                'BOE-A-2007-6115': 'Ley de Igualdad',
                'BOE-A-1954-6364': 'LEF',
                'BOE-A-2007-7788': 'EBEP'
            };

            const url = questionData.Legal_Reference;
            if (!url) return "Sin referencia";
            
            let lawText = '';
            let articleText = '';

            const boeMatch = url.match(/id=(BOE-A-\d{4}-\d+)/);
            if (boeMatch && lawMapping[boeMatch[1]]) {
                lawText = lawMapping[boeMatch[1]];
            }

            const articleMatch = url.match(/#a(\d+)/);
            if (articleMatch) {
                articleText = `, art. ${articleMatch[1]}`;
            }

            return lawText ? `${lawText}${articleText}` : "Ver disposici√≥n";
        };

        const startGame = () => {
            const num = parseInt(numQuestionsInput.value);
            if (isNaN(num) || num <= 0 || num > allQuestions.length) {
                errorBox.textContent = `Introduce un n√∫mero v√°lido entre 1 y ${allQuestions.length}.`;
                errorBox.classList.remove('hidden');
                return;
            }
            
            // Resetear estado
            correctAnswers = [];
            incorrectAnswers = [];
            currentQuestionIndex = 0;
            
            // Selecci√≥n completamente aleatoria usando Fisher-Yates
            const shuffled = shuffleArray(allQuestions);
            
            // Tomar las primeras 'num' preguntas del array mezclado
            quizQuestions = shuffled.slice(0, num);
            
            // Cambiar pantalla
            setupScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            displayQuestion();
        };

        const displayQuestion = () => {
            if (currentQuestionIndex >= quizQuestions.length) {
                showResults();
                return;
            }
            
            const q = quizQuestions[currentQuestionIndex];
            occurrenceTracker.increment(q.ID);
            
            // Mostrar pregunta
            category.textContent = q.Category;
            questionText.textContent = q.Question;
            
            // Formatear respuesta
            let formattedAnswer = q.Answer
                .replace(/Palabras clave:/g, '<br><br><strong>Palabras clave:</strong>')
                .replace(/Analog√≠a:/g, '<br><br><strong>Analog√≠a:</strong>');
            correctAnswerText.innerHTML = formattedAnswer;
            
            reasoningText.textContent = q.Reasoning;
            
            // Referencia legal
            if (q.Legal_Reference) {
                legalRefLink.href = q.Legal_Reference;
                legalRefText.textContent = formatLegalReferenceText(q);
                legalRefLink.style.display = 'inline-block';
            } else {
                legalRefLink.style.display = 'none';
            }

            // Actualizar contadores
            currentQNum.textContent = currentQuestionIndex + 1;
            totalQNum.textContent = quizQuestions.length;
            
            // Resetear interfaz
            userAnswer.value = '';
            feedbackSection.classList.add('hidden');
            aiResponseContainer.classList.add('hidden');
            aiResponseContent.innerHTML = '';
            aiEnhanceButton.classList.remove('hidden');
            verifyButton.classList.remove('hidden');
            evalButtons.classList.remove('hidden');
        };
        
        const showFeedback = () => {
            verifyButton.classList.add('hidden');
            feedbackSection.classList.remove('hidden');
            feedbackMessage.classList.add('hidden');
        };

        const handleEvaluation = (isCorrect) => {
            evalButtons.classList.add('hidden');
            
            if (isCorrect) {
                correctAnswers.push(quizQuestions[currentQuestionIndex]);
                feedbackMessage.textContent = '¬°Excelente! Respuesta correcta. üéâ';
                feedbackMessage.className = 'p-4 text-white font-bold rounded-lg border-l-4 text-center feedback-correct';
            } else {
                incorrectAnswers.push(quizQuestions[currentQuestionIndex]);
                feedbackMessage.textContent = '¬°√Ånimo! Lo importante es aprender de los errores. üí™';
                feedbackMessage.className = 'p-4 text-white font-bold rounded-lg border-l-4 text-center feedback-incorrect';
            }
            feedbackMessage.classList.remove('hidden');
            
            // Pasar autom√°ticamente a la siguiente pregunta despu√©s de 2 segundos
            setTimeout(() => {
                currentQuestionIndex++;
                displayQuestion();
            }, 2000);
        };
        
        const getAIEnhancement = async () => {
            const q = quizQuestions[currentQuestionIndex];
            const apiKey = geminiApiKeyInput.value.trim();
            
            aiEnhanceButton.classList.add('hidden');
            aiResponseContainer.classList.remove('hidden');
            aiSpinner.classList.remove('hidden');
            aiResponseContent.innerHTML = '';

            try {
                if (!apiKey) {
                    // Simulaci√≥n mejorada si no hay API key
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    const mockResponse = `
                        <h5 class="font-bold text-violet-300 mb-3">ü§ñ Explicaci√≥n Simulada (sin API key):</h5>
                        <div class="space-y-3 text-slate-300">
                            <p><strong>üìö Concepto clave:</strong> Esta pregunta se centra en <strong>${q.Category}</strong>. El concepto fundamental es entender que ${q.Answer.split('.')[0].toLowerCase()}.</p>
                            <p><strong>üèõÔ∏è Ejemplo pr√°ctico:</strong> Un caso t√≠pico ser√≠a cuando una administraci√≥n necesita aplicar este principio en la gesti√≥n cotidiana de procedimientos administrativos.</p>
                            <p><strong>üí° Truco para recordar:</strong> Piensa en esta regla como una protecci√≥n que garantiza la seguridad jur√≠dica y los derechos de los ciudadanos.</p>
                            <p><strong>‚öñÔ∏è Importancia jur√≠dica:</strong> Este principio es fundamental en el derecho administrativo espa√±ol y aparece frecuentemente en ex√°menes de oposiciones.</p>
                        </div>
                        <div class="mt-4 p-3 bg-blue-900 bg-opacity-30 rounded-lg">
                            <p class="text-xs text-blue-300">üí° <strong>Consejo:</strong> Introduce tu API key de Google Gemini (gratuita) para obtener explicaciones personalizadas y m√°s detalladas.</p>
                        </div>
                    `;
                    
                    aiResponseContent.innerHTML = mockResponse;
                } else {
                    // Usar API real de Google Gemini
                    const prompt = `Act√∫a como un profesor experto en derecho administrativo espa√±ol. Explica esta pregunta de oposiciones de forma pedag√≥gica y motivadora:

**Pregunta:** ${q.Question}
**Respuesta Correcta:** ${q.Answer}
**Justificaci√≥n:** ${q.Reasoning}

Proporciona una explicaci√≥n estructurada que incluya:
1. üìö **Concepto clave simplificado** - Explica el concepto de forma clara
2. üèõÔ∏è **Ejemplo pr√°ctico real** - Da un ejemplo concreto de aplicaci√≥n
3. üí° **Truco para recordarlo** - Proporciona una t√©cnica mnemot√©cnica o analog√≠a
4. ‚öñÔ∏è **Importancia jur√≠dica** - Explica por qu√© es relevante en el derecho administrativo

Usa un tono motivador y educativo. Mant√©n cada secci√≥n concisa pero informativa.`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                role: "user",
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                topP: 0.8,
                                maxOutputTokens: 1000
                            }
                        })
                    });

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error.message);
                    }

                    if (!result.candidates || result.candidates.length === 0) {
                        throw new Error('No se recibi√≥ respuesta de la IA');
                    }

                    const aiText = result.candidates[0]?.content?.parts[0]?.text || 'No se pudo generar respuesta';
                    
                    // Formatear con markdown b√°sico
                    const formattedResponse = aiText
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/\n\n/g, '</p><p>')
                        .replace(/\n/g, '<br>');
                    
                    aiResponseContent.innerHTML = `
                        <h5 class="font-bold text-violet-300 mb-3">ü§ñ Explicaci√≥n con Google Gemini:</h5>
                        <div class="text-slate-300">
                            <p>${formattedResponse}</p>
                        </div>
                        <div class="mt-4 p-2 bg-green-900 bg-opacity-30 rounded-lg">
                            <p class="text-xs text-green-300">‚úÖ Respuesta generada con inteligencia artificial</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error AI:', error);
                aiResponseContent.innerHTML = `
                    <p class="text-red-400">Error al contactar con la IA: ${error.message}</p>
                    <div class="mt-3 p-3 bg-red-900 bg-opacity-30 rounded-lg">
                        <p class="text-sm text-red-300">Posibles soluciones:</p>
                        <ul class="text-xs text-red-200 mt-1 space-y-1">
                            <li>‚Ä¢ Verifica tu API key de Google Gemini</li>
                            <li>‚Ä¢ Obt√©n una API key gratuita en <a href="https://ai.google.dev" target="_blank" class="text-blue-400 hover:underline">ai.google.dev</a></li>
                            <li>‚Ä¢ Comprueba tu conexi√≥n a internet</li>
                        </ul>
                    </div>
                `;
            } finally {
                aiSpinner.classList.add('hidden');
            }
        };

        const showResults = () => {
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            correctCount.textContent = correctAnswers.length;
            incorrectCount.textContent = incorrectAnswers.length;
            
            const percentage = quizQuestions.length > 0 ? (correctAnswers.length / quizQuestions.length) * 100 : 0;
            
            if (percentage >= 80) {
                finalMessage.textContent = "¬°Magn√≠fico trabajo! Tu esfuerzo est√° dando frutos. Sigue as√≠.";
            } else if (percentage >= 50) {
                finalMessage.textContent = "¬°Buen progreso! Est√°s construyendo una base s√≥lida. ¬°A por la siguiente!";
            } else {
                finalMessage.textContent = "Cada error es un paso m√°s hacia el √©xito. ¬°No te rindas, la constancia es la clave!";
            }
            
            // Secci√≥n de repaso
            if (incorrectAnswers.length > 0) {
                reviewList.innerHTML = incorrectAnswers.map((q, i) => 
                    `<div class="p-3 bg-slate-900 rounded-lg">
                        <p class="font-semibold text-slate-300">${i + 1}. ${q.Question}</p>
                        <p class="mt-1 text-green-400"><strong>R:</strong> ${q.Answer}</p>
                    </div>`
                ).join('');
                reviewSection.classList.remove('hidden');
            } else {
                reviewSection.classList.add('hidden');
            }
            
            // Tabla de estad√≠sticas
            const occurrenceData = occurrenceTracker.get();
            occurrenceTableBody.innerHTML = allQuestions.map(q => 
                `<tr>
                    <td class="p-2">${q.Question.substring(0, 70)}...</td>
                    <td class="p-2 w-28 text-center font-bold">${occurrenceData[q.ID] || 0}</td>
                </tr>`
            ).join('');
        };
        
        const restartApp = () => {
            resultsScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            
            // Resetear a selecci√≥n inicial
            loadingSection.classList.add('hidden');
            configSection.classList.add('hidden');
            csvSelection.classList.remove('hidden');
            
            // Resetear selecci√≥n
            document.querySelectorAll('.csv-option').forEach(option => {
                option.classList.remove('selected');
            });
            selectedCSV = null;
            
            // Resetear inputs
            numQuestionsInput.value = '';
            numQuestionsInput.disabled = true;
            startButton.disabled = true;
            
            // Ocultar mensajes
            errorBox.classList.add('hidden');
            infoBox.classList.add('hidden');
            
            // Resetear datos
            allQuestions = [];
            quizQuestions = [];
            correctAnswers = [];
            incorrectAnswers = [];
            currentQuestionIndex = 0;
        };

        // --- EVENT LISTENERS ---
        
        // Selecci√≥n de CSV
        document.querySelectorAll('.csv-option').forEach(option => {
            option.addEventListener('click', () => {
                // Remover selecci√≥n anterior
                document.querySelectorAll('.csv-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Seleccionar nuevo
                option.classList.add('selected');
                selectedCSV = option.dataset.csv;
                
                // Cargar CSV
                loadSelectedCSV();
            });
        });

        startButton.addEventListener('click', startGame);
        verifyButton.addEventListener('click', showFeedback);
        aiEnhanceButton.addEventListener('click', getAIEnhancement);
        correctBtn.addEventListener('click', () => handleEvaluation(true));
        incorrectBtn.addEventListener('click', () => handleEvaluation(false));
        restartButton.addEventListener('click', restartApp);

        // Reconocimiento de voz
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.interimResults = false;
            
            micButton.addEventListener('click', () => {
                try {
                    micStatus.textContent = 'üé§ Escuchando...';
                    recognition.start();
                } catch(e) {
                    micStatus.textContent = 'El micr√≥fono ya est√° activo.';
                }
            });
            
            recognition.onresult = (event) => {
                userAnswer.value = event.results[0][0].transcript;
                micStatus.textContent = 'Respuesta capturada ‚úì';
                setTimeout(() => { micStatus.textContent = ''; }, 2000);
            };
            
            recognition.onerror = (event) => {
                micStatus.textContent = `Error: ${event.error}`;
                setTimeout(() => { micStatus.textContent = ''; }, 3000);
            };
            
            recognition.onend = () => {
                if (micStatus.textContent === 'üé§ Escuchando...') {
                    micStatus.textContent = '';
                }
            };
        } else {
            micButton.style.display = 'none';
        }

        // Guardar API key en localStorage
        geminiApiKeyInput.addEventListener('input', () => {
            localStorage.setItem('geminiApiKey', geminiApiKeyInput.value);
        });

        // Cargar API key guardada
        const savedApiKey = localStorage.getItem('geminiApiKey');
        if (savedApiKey) {
            geminiApiKeyInput.value = savedApiKey;
        }

        // --- INICIAR APLICACI√ìN ---
        // Mostrar pantalla de selecci√≥n de CSV
        loadingSection.classList.add('hidden');
        configSection.classList.add('hidden');
        csvSelection.classList.remove('hidden');
    });
    </script>
</body>
</html>
